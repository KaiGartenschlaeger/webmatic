#!/bin/sh

ADDONNAME=webmatic
WWWDIR=/usr/local/etc/config/addons/www/${ADDONNAME}
RCDDIR=/usr/local/etc/config/rc.d
USERDIR=/usr/local/etc/config/addons/www/${ADDONNAME}_user

if [ "$1" == "" ]; then
  echo "CCU1"
  lcdtool "Installing WebMatic..."
  mount -t yaffs /dev/mtdblock3 /usr/local
elif [ "$1" == "CCU2" ]; then
  echo "CCU2"
  mount -t ubifs ubi1:user /usr/local
elif [ "$1" == "HM-RASPBERRYMATIC" ]; then
  echo "HM-RASPBERRYMATIC"
  mount /usr/local
fi

# create
mkdir -p ${WWWDIR}
chmod 755 ${WWWDIR}
mkdir -p ${RCDDIR}
chmod 755 ${RCDDIR}
mkdir -p ${USERDIR}
chmod 755 ${USERDIR}

# cleanup wwwdir
rm -rf ${WWWDIR}/*

# copy
cp -R ${ADDONNAME}/* ${WWWDIR}/
cp VERSION ${WWWDIR}/
cp -R -n ${ADDONNAME}_user/* ${USERDIR}/
cp webmatic-dlg ${RCDDIR}/
chmod +x ${RCDDIR}/webmatic-dlg

# sync filesystem to make sure all changes are written to disk
sync

if [ "$1" = "" ]; then
  echo "CCU1"
  lcdtool "Reboot...             "
  lcdtool -a 0x40 -t bin 00
  echo "x" > /dev/watchdog
  reboot
  while true ; do true ;  done
elif [ "$1" = "CCU2" ]; then
  echo "CCU2"
  # CCU2 always reboots after Addon/Firmware Update
elif [ "$1" = "HM-RASPBERRYMATIC" ]; then
  echo "HM-RASPBERRYMATIC"
  # RASPBERRYMATIC always reboots after Addon/Firmware Update
fi
