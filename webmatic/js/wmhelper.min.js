
var webmaticVersion="0";var newWebmaticVersion=webmaticVersion;var storageVersion=9;var debugModus=true;var testSite=false;var lastClickType=-1;var oldID=-1;var lastClickID=-1;var readModus=false;var prevItem=0;var saveDataToFile=false;var newVersion=false;var mustBeSaved=false;var client="";var excludeFromRefresh=[];var programsMap,functionsMap,roomsMap,favoritesMap,variablesMap,optionsMap,devicesMap,recognizeMap;var programsClientMap={},functionsClientMap={},roomsClientMap={},favoritesClientMap={},optionsClientMap={},variablesClientMap={},devicesClientMap={};var resultProgramsMap={},resultFunctionsMap={},resultRoomsMap={},resultFavoritesMap={},resultVariablesMap={},resultOptionsMap={},resultDevicesMap={};var theme,font,gfxClass;var loadedFont=["a"];var today=new Date();var dateNow=(today.getDate()<10?"0"+today.getDate():today.getDate())+"."+(today.getMonth()+1<10?"0"+today.getMonth()+1:today.getMonth()+1)+"."+today.getFullYear();var refreshTimer=setInterval(function(){checkrefreshPage()},1000);var lastTime=-1;function checkrefreshPage(){var b=new Date();var a=b.getTime();if(lastTime!==-1){if(a-lastTime>60000){if(lastClickType===1||lastClickType===2||lastClickType===3||lastClickType===5||lastClickType===6){refreshPage(0)}refreshServiceMessages();lastTime=a}}else{lastTime=a}}function restartTimer(){var a=new Date();lastTime=a.getTime()}function addSetButton(d,b,i,g,h,j,a,f,e){var c="";if(!j){c+="<p class='ui-li-desc'>"}if(a){c+="<a href='#' data-value='"+g+"' data-role='button' class='ui-btn-active' data-inline='true' data-theme='"+theme+"'>"+i+"</a>"}else{c+="<a href='#' id='setButton_"+b+"' "+(e?"data-special='"+e+"' ":"")+"data-id='"+b+"' data-parent-id='"+d+"' data-refresh='"+f+"' data-value='"+g+"' data-role='button' data-inline='true'>"+i+"</a>"}if(!j){c+="<i>"+h+"</i> <span id='info_"+b+"' class='valueOK valueOK-"+theme+"'></span></p>"}return c}function addSetControlGroup(e,a,c,b,i,f,g,h){var d="";d+="<div data-role='controlgroup' data-type='horizontal'>";if(g){d+=g}d+=addSetButton(e,a,c,0,i,true,f===0,false);d+=addSetButton(e,a,"20%",0.2,i,true,f===0.2,false);d+=addSetButton(e,a,"40%",0.4,i,true,f===0.4,false);d+=addSetButton(e,a,"60%",0.6,i,true,f===0.6,false);d+=addSetButton(e,a,"80%",0.8,i,true,f===0.8,false);d+=addSetButton(e,a,b,1,i,true,f===1,false);if(h){d+=h}d+="</div>";return d}function addStartProgramButton(f,e,d,c,a){var b="<p class='ui-li-desc'><a href='#' "+(!a?"class='ui-link ui-btn ui-icon-gear ui-btn-icon-left ui-btn-inline ui-shadow ui-corner-all ui-state-disabled'":"data-role='button' data-inline='true' data-icon='gear'")+" id='startProgramButton_"+e+"' data-parent-id='"+f+"' data-id='"+e+"'>"+d+"</a></div>";b+="<i>"+c+"</i> <span id='info_"+e+"' class='valueOK valueOK-"+theme+"'></span></p>";return b}function addSetNumber(e,a,j,k,c,h,b,g,i,f){var d="<div class='ui-field-contain'>";d+="<input type='range' value='"+j*g+"' min='"+c*g+"' max='"+h*g+"' step='"+b*g+"' data-factor='"+g+"' id='setValue_"+a+"' data-id='"+a+"' data-highlight='true' data-theme='"+theme+"'/>";d+=" ("+c*g+" - "+h*g+" <span id='unit_ "+a+"'>"+k+"</span>) ";d+="<a href='#' id='setButton_"+a+"' data-parent-id='"+e+"' data-id='"+a+"' data-refresh='"+f+"' data-role='button' data-inline='true' data-icon='check'>"+mapText("SET")+"</a>";d+="<i class='ui-li-desc'>"+i+"</i> <span id='info_"+a+"' class='valueOK valueOK-"+theme+"'></span>";d+="</div>";return d}function addSetBoolButtonList(c,d,i,g,e,f,j,h){var b="<div class=ui-field-contain'>";b+="<div data-role='controlgroup' data-type='horizontal'>";var a="";if(i==="false"||i===""){a="class='ui-btn-active'"}else{a="id='setButton_"+d+"' data-parent-id='"+c+"' data-id='"+d+"' data-refresh='"+h+"'"}b+="<a href='#' "+a+" data-value='false' data-role='button' data-inline='true' data-theme='"+theme+"'>"+g+"</a>";if(i==="true"){a="class='ui-btn-active'"}else{a="id='setButton_"+d+"' data-parent-id='"+c+"' data-id='"+d+"' data-refresh='"+h+"'"}b+="<a href='#' "+a+" data-value='true' data-role='button' data-inline='true' data-theme='"+theme+"'>"+e+"</a>";b+="</div>";b+="</div>";b+=" <span id='unit_ "+d+"'>"+f+"</span> ";b+="<i class='ui-li-desc'>"+j+"</i> <span id='info_"+d+"' class='valueOK valueOK-"+theme+"'></span>";return b}function addSetValueList(b,e,i,a,g,j,h,c){var f=parseInt(i);var d=a.split(";");if(c==="small"||(d.length<6&&c!=="big")){return addSmallList(f,d,e,b,g,j,h)}else{return addBigList(f,d,e,b,g,j,h)}}function addSmallList(f,e,d,b,g,j,h){var c="<div class='ui-field-contain'>";c+="<div data-role='controlgroup' data-type='horizontal'>";for(var a=0;a<e.length;a++){if(f===a){c+="<a href='#' data-value='"+a+"' data-role='button' data-inline='true' class='ui-btn-active' data-theme='"+theme+"'>"+e[a]+"</a>"}else{c+="<a href='#' id='setButton_"+d+"' data-parent-id='"+b+"' data-id='"+d+"' data-refresh='"+h+"' data-value='"+a+"' data-role='button' data-inline='true'>"+e[a]+"</a>"}}c+="</div>";c+="</div>";c+="<span id='unit_ "+d+"'>"+g+"</span> ";c+="<i class='ui-li-desc'>"+j+"</i> <span id='info_"+d+"' class='valueOK valueOK-"+theme+"'></span>";return c}function addBigList(f,e,d,b,g,j,h){var c="<div class='ui-field-contain'>";c+="<div data-role='controlgroup' data-type='horizontal'>";c+="<select id='selector_"+d+"' data-theme='"+theme+"'>";for(var a=0;a<e.length;a++){if(f===a){c+="<option value='"+a+"' selected='selected'>"+e[a]+"</option>"}else{c+="<option value='"+a+"'>"+e[a]+"</option>"}}c+="</select>";c+="<span id='unit_ "+d+"'>"+g+"</span> <a href='#' id='setValueBigList_"+d+"' data-parent-id='"+b+"' data-id='"+d+"' data-refresh='"+h+"' data-role='button' data-inline='true' data-icon='check'>&nbsp;</a>";c+="<i class='ui-li-desc'>"+j+"</i> <span id='info_"+d+"' class='valueOK valueOK-"+theme+"'></span>";c+="</div>";c+="</div>";return c}function addSetText(f,c,d,e,b){var a="<div class=ui-field-contain'>";d=d.replace(/\"/g,"&quot;");if(d.length>40){a+="<textarea id='setValue_"+c+"' data-parent-id='"+f+"' data-id='"+c+"' style='width:20em; display:inline-block;'>"+d+"</textarea>"}else{a+="<input type='text' id='setValue_"+c+"' data-parent-id='"+f+"' data-id='"+c+"' value=\""+d+"\" style='width:20em; display:inline-block;'/>"}a+=" <span id='unit_ "+c+"'>"+e+"</span> <a href='#' id='setTextButton_"+c+"' data-parent-id='"+f+"' data-id='"+c+"' data-role='button' data-inline='true' data-icon='check'>"+mapText("SET")+"</a>";a+="<i class='ui-li-desc'>"+b+"</i> <span id='info_"+c+"' class='valueOK valueOK-"+theme+"'></span>";a+="</div>";return a}function addHTML(f,d,e,c,a){var b="<div class='ui-field-contain'"+(a?"":" ui-grid-a")+"'>";b+="<div class='evalScript"+(a?"":" ui-block-a")+"'>"+e+"</div>";if(!a){b+="<div class='ui-block-b'><textarea id='setValue_"+d+"' data-parent-id='"+f+"' data-id='"+d+"' style='width:20em; display:inline-block;'>"+e+"</textarea>";b+="<a href='#' id='setTextButton_"+d+"' data-parent-id='"+f+"' data-id='"+d+"' data-role='button' data-inline='true' data-icon='check'>"+mapText("SET")+"</a>";b+="<i class='ui-li-desc'>"+c+"</i> <span id='info_"+d+"' class='valueOK valueOK-"+theme+"'></span>";b+="</div>"}b+="</div>";return b}function addHistorianDiagram(d,g,b,i,f){excludeFromRefresh.push(g);if(!b){f=false;b=";;1D"}var c="";if(resultOptionsMap.ccu_historian===""){f=false;c=mapText("HISTORIAN_WARNING")}var h=b.split(";");if(h.length!==3){f=false;h=["","","1D"]}var e="<div class='ui-field-contain'"+(f?"":" ui-grid-a")+"'>";if(f){e+="<div id='chart_"+g+"'></div>";$.ajax({url:resultOptionsMap.ccu_historian+"/query/json.gy?i="+h[0]+"&d="+h[2],method:"GET",dataType:"JSONP",contentType:"application/json",jsonpCallback:"historian_callback",success:function(k){if($("#chart_"+g).length){reloadHistorianChart(g,k)}else{$("#dataList").one("create",function(){reloadHistorianChart(g,k)})}},error:function(k,l){log("Request Historian chart failed: "+l,2)}})}else{if(c!==""){e+="<div class='ui-block-a'>"+c+"</div>"}e+="<div class='ui-block-a'>CCU-Historian-ID</div>";e+="<div class='ui-block-b'>";e+="<input type='text' placeholder='18,19,20...' id='hisHistorianID_"+g+"' value=\""+h[0]+'" />';e+="</div>";e+="<div class='ui-block-a'>Homematic-ID</div>";e+="<div class='ui-block-b'>";e+="<input type='text' placeholder='8918,8919,8920...' id='hisHMID_"+g+"' value=\""+h[1]+'" />';e+="</div>";e+="<div class='ui-block-a'>"+mapText("HISTORIAN_DURATION")+"</div>";e+="<div class='ui-block-b'>";e+="<div data-role='controlgroup' data-type='horizontal'>";var j=h[2].slice(0,-1);var a=h[2].substr(h[2].length-1);e+="<input type='number' min='1' max='100' id='hisDuration_"+g+"' value=\""+j+"\" data-wrapper-class='controlgroup-textinput ui-btn'/>";e+="<select id='hisSelector_"+g+"' data-theme='"+theme+"'>";e+="<option value='s' "+(a==="s"?"selected='selected'":"")+">"+mapText("TIME_SEC_PLURAL")+"</option>";e+="<option value='m' "+(a==="m"?"selected='selected'":"")+">"+mapText("TIME_MIN_PLURAL")+"</option>";e+="<option value='h' "+(a==="h"?"selected='selected'":"")+">"+mapText("TIME_H_PLURAL")+"</option>";e+="<option value='D' "+(a==="D"?"selected='selected'":"")+">"+mapText("TIME_DAY_PLURAL")+"</option>";e+="<option value='W' "+(a==="W"?"selected='selected'":"")+">"+mapText("TIME_W_PLURAL")+"</option>";e+="<option value='M' "+(a==="M"?"selected='selected'":"")+">"+mapText("TIME_MON_PLURAL")+"</option>";e+="<option value='Y' "+(a==="Y"?"selected='selected'":"")+">"+mapText("TIME_Y_PLURAL")+"</option>";e+="</select>";e+="</div>";e+="</div>";e+="<div class='ui-block-a'>";e+="<a href='#' id='saveHistorianData_"+g+"' data-parent-id='"+d+"' data-id='"+g+"' data-role='button' data-inline='true' data-icon='check'>"+mapText("SET")+"</a>";e+="<i class='ui-li-desc'>"+i+"</i> <span id='info_"+g+"' class='valueOK valueOK-"+theme+"'></span>";e+="</div>"}e+="</div>";return e}function addReadonlyVariable(e,i,j,c,g,b,h,f){var a="";if(c==="2"){if(i==="true"){a=f}else{a=h}}else{if(c==="4"){a=parseFloat(i)}else{if(c==="16"){var d=b.split(";");a=d[parseInt(i)]}else{a=i}}}if(c==="20"&&g.toUpperCase()==="HTML"){return addHTML("",e,i,j,true)}else{if(c==="20"&&g.toUpperCase()==="HISTORIAN"){return addHistorianDiagram("",e,i,j,true)}else{return"<p><img class='ui-img-"+theme+"' src='img/channels/unknown.png' style='max-height:20px'><span class='valueInfo valueInfo-"+theme+"'>"+a+" "+g+" </span></p><i class='ui-li-desc'>"+j+"</i>"}}}function reloadHistorianChart(b,a){$.jqplot("chart_"+b,[a],{axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{formatString:"%#d %b %#H:%M",angle:-60}}},series:[{lineWidth:1,markerOptions:{style:"square"}}],highlighter:{show:true,sizeAdjust:5.5},cursor:{zoom:true,show:true},grid:{backgroundColor:"#F4F4F4"},animated:true})}function log(a,b){if(debugModus){if(b===0){console.info(a)}else{if(b===1){console.warn(a)}else{if(b===2){console.error(a)}else{console.log(a)}}}}}function getDateFromString(d){var a=d.substring(0,2);var f=d.substring(3,5)-1;var e=d.substring(6,10);var c=d.substring(11,13);var b=d.substring(14,16);var g=d.substring(17,19);return new Date(e,f,a,c,b,g)}function getResultMap(a){switch(a){case"variables":return resultVariablesMap;case"programs":return resultProgramsMap;case"favorites":return resultFavoritesMap;case"rooms":return resultRoomsMap;case"functions":return resultFunctionsMap;case"devices":return resultDevicesMap}}function setResultMap(a,b){switch(a){case"variables":resultVariablesMap=b;break;case"programs":resultProgramsMap=b;break;case"favorites":resultFavoritesMap=b;break;case"rooms":resultRoomsMap=b;break;case"functions":resultFunctionsMap=b;break;case"devices":resultDevicesMap=b;break}}function getMap(a){switch(a){case"variables":return variablesMap;case"programs":return programsMap;case"favorites":return favoritesMap;case"rooms":return roomsMap;case"functions":return functionsMap;case"devices":return devicesMap}}function setMap(a,b){switch(a){case"variables":variablesMap=b;break;case"programs":programsMap=b;break;case"favorites":favoritesMap=b;break;case"rooms":roomsMap=b;break;case"functions":functionsMap=b;break;case"devices":devicesMap=b;break}}function loadLocalStorageMap(a,b){switch(a){case"variables":variablesMap=JSON.parse(localStorage.getItem("webmatic"+a+"Map"));break;case"programs":programsMap=JSON.parse(localStorage.getItem("webmatic"+a+"Map"));break;case"favorites":favoritesMap=JSON.parse(localStorage.getItem("webmatic"+a+"Map"));break;case"rooms":roomsMap=JSON.parse(localStorage.getItem("webmatic"+a+"Map"));break;case"functions":functionsMap=JSON.parse(localStorage.getItem("webmatic"+a+"Map"));break;case"devices":devicesMap=JSON.parse(localStorage.getItem("webmatic"+a+"Map"+b));break}}function createOneMap(a,b,c){switch(a){case"config":$.each(optionsMap,function(d,e){if(d in optionsClientMap){resultOptionsMap[d]=optionsClientMap[d]}else{resultOptionsMap[d]=e}});if(b){if(resultOptionsMap[b]===c){checkAndChange(b,c)}}break;case"variables":$.each(variablesMap,function(d,e){if(d in variablesClientMap){resultVariablesMap[d]=variablesClientMap[d]}else{resultVariablesMap[d]=e}});break;case"programs":$.each(programsMap,function(d,e){if(d in programsClientMap){resultProgramsMap[d]=programsClientMap[d]}else{resultProgramsMap[d]=e}});break;case"favorites":$.each(favoritesMap,function(d,e){if(d in favoritesClientMap){resultFavoritesMap[d]=favoritesClientMap[d]}else{resultFavoritesMap[d]=e}});break;case"rooms":$.each(roomsMap,function(d,e){if(d in roomsClientMap){resultRoomsMap[d]=roomsClientMap[d]}else{resultRoomsMap[d]=e}});break;case"functions":$.each(functionsMap,function(d,e){if(d in functionsClientMap){resultFunctionsMap[d]=functionsClientMap[d]}else{resultFunctionsMap[d]=e}});break;case"devices":$.each(devicesMap,function(d,e){if(d in devicesClientMap){resultDevicesMap[d]=devicesClientMap[d]}else{resultDevicesMap[d]=e}});break}}function isReadOnly(b){if(!readModus){return false}var a="";var f=[];var c=b.indexOf("(");if(c!==-1){var d=b.indexOf(")",c);if(d!==-1){var e=b.substring(c+1,d);f=e.split(",");if(f.length>=1){a=f[0].toLowerCase()}}}if(a==="h"||a==="dk"||a==="d"||a==="g"){return false}if(resultOptionsMap.systemvar_readonly&&readModus){return a!=="w"}return a==="r"}var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(c){var a="";var k,h,f,j,g,e,d;var b=0;c=Base64._utf8_encode(c);while(b<c.length){k=c.charCodeAt(b++);h=c.charCodeAt(b++);f=c.charCodeAt(b++);j=k>>2;g=((k&3)<<4)|(h>>4);e=((h&15)<<2)|(f>>6);d=f&63;if(isNaN(h)){e=d=64}else{if(isNaN(f)){d=64}}a=a+this._keyStr.charAt(j)+this._keyStr.charAt(g)+this._keyStr.charAt(e)+this._keyStr.charAt(d)}return a},decode:function(c){var a="";var k,h,f;var j,g,e,d;var b=0;c=c.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(b<c.length){j=this._keyStr.indexOf(c.charAt(b++));g=this._keyStr.indexOf(c.charAt(b++));e=this._keyStr.indexOf(c.charAt(b++));d=this._keyStr.indexOf(c.charAt(b++));k=(j<<2)|(g>>4);h=((g&15)<<4)|(e>>2);f=((e&3)<<6)|d;a=a+String.fromCharCode(k);if(e!==64){a=a+String.fromCharCode(h)}if(d!==64){a=a+String.fromCharCode(f)}}a=Base64._utf8_decode(a);return a},_utf8_encode:function(b){b=b.replace(/\r\n/g,"\n");var a="";for(var e=0;e<b.length;e++){var d=b.charCodeAt(e);if(d<128){a+=String.fromCharCode(d)}else{if((d>127)&&(d<2048)){a+=String.fromCharCode((d>>6)|192);a+=String.fromCharCode((d&63)|128)}else{a+=String.fromCharCode((d>>12)|224);a+=String.fromCharCode(((d>>6)&63)|128);a+=String.fromCharCode((d&63)|128)}}}return a},_utf8_decode:function(a){var b="";var d=0;var e=c1=c2=0;while(d<a.length){e=a.charCodeAt(d);if(e<128){b+=String.fromCharCode(e);d++}else{if((e>191)&&(e<224)){c2=a.charCodeAt(d+1);b+=String.fromCharCode(((e&31)<<6)|(c2&63));d+=2}else{c2=a.charCodeAt(d+1);c3=a.charCodeAt(d+2);b+=String.fromCharCode(((e&15)<<12)|((c2&63)<<6)|(c3&63));d+=3}}}return b}};function getTimeDiffString(b,c){var d=(getDateFromString(c)-getDateFromString(b))/1000;var a;if(d<0){return""}else{if(d<60){a=Math.floor(d+0.5);return mapText("TIME_PREFIX")+" "+a+" "+(a===1?mapText("TIME_SEC_SINGULAR"):mapText("TIME_SEC_PLURAL"))+" "+mapText("TIME_SUFFIX")}else{if(d<60*60){a=Math.floor(d/60+0.5);return mapText("TIME_PREFIX")+" "+a+" "+(a===1?mapText("TIME_MIN_SINGULAR"):mapText("TIME_MIN_PLURAL"))+" "+mapText("TIME_SUFFIX")}else{if(d<60*60*24){a=Math.floor(d/(60*60)+0.5);return mapText("TIME_PREFIX")+" "+a+" "+(a===1?mapText("TIME_H_SINGULAR"):mapText("TIME_H_PLURAL"))+" "+mapText("TIME_SUFFIX")}else{if(d<60*60*24*30.5){a=Math.floor(d/(60*60*24)+0.5);return mapText("TIME_PREFIX")+" "+a+" "+(a===1?mapText("TIME_DAY_SINGULAR"):mapText("TIME_DAY_PLURAL"))+" "+mapText("TIME_SUFFIX")}else{if(d<60*60*24*30.5*12){a=Math.floor(d/(60*60*24*30.5)+0.5);return mapText("TIME_PREFIX")+" "+a+" "+(a===1?mapText("TIME_MON_SINGULAR"):mapText("TIME_MON_PLURAL"))+" "+mapText("TIME_SUFFIX")}else{a=Math.floor(d/(60*60*24*30.5*12)+0.5);if(a<40){return mapText("TIME_PREFIX")+" "+a+" "+(a===1?mapText("TIME_Y_SINGULAR"):mapText("TIME_Y_PLURAL"))+" "+mapText("TIME_SUFFIX")}}}}}}}return""}function checkAndChange(a,b){if(a==="default_theme"&&b!==theme){changeTheme(b)}else{if(a==="default_font"&&b!==font){changeFont(b)}else{if(a==="default_menugfxsize"&&b!==gfxClass){changeMenuGfx(b)}else{if(a==="favorites"||a==="rooms"||a==="functions"||a==="variables"||a==="programs"||a==="others"){if(b&&$("#"+a+"MainMenu").is(":hidden")){$("#"+a+"MainMenu").fadeIn()}else{if(!b&&!$("#"+a+"MainMenu").is(":hidden")){$("#"+a+"MainMenu").fadeOut()}}}}}}};